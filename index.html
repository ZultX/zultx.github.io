<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZultX ‚Äî v1.1</title>
<style>
:root{
  --bg:#0b0b0f;
  --panel:#0f1113;
  --muted:#9aa0a6;
  --text:#e8eaed;
  --accent:#18d018;
  --outline:#1a1a1a;
  --glass: rgba(255,255,255,0.03);
  --side-w: 320px;
  --header-bg: #ffffff; /* user requested white top */
  --header-text: #0a0a0a;
  --tip-color: #2e8b57;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:var(--bg)}
header{
  height:72px;
  display:flex;
  align-items:center;
  gap:12px;
  padding:10px 16px;
  border-bottom:1px solid var(--outline);
  background:var(--header-bg);
  color:var(--header-text);
  position:relative;
  z-index:40;
  box-shadow:0 6px 18px rgba(0,0,0,0.2);
}
.logo{
  font-weight:900;
  letter-spacing:0.6px;
  font-size:20px;
  display:flex;
  align-items:center;
  gap:8px;
}
.logo .fire{
  background:linear-gradient(90deg,#ff3b3b,#ff8a00);
  -webkit-background-clip:text;
  background-clip:text;
  color:transparent;
  font-weight:900;
}
.logo .x-black{
  background:#000;
  color:#fff;
  padding:4px 8px;
  border-radius:6px;
  font-weight:800;
}
.top-center {
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  align-items:center;
  gap:12px;
}
.top-center button {
  background:#fff;
  border:1px solid #e6e6e6;
  padding:8px 12px;
  border-radius:999px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}
.top-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
.top-actions button{background:var(--glass);border:1px solid var(--outline);padding:8px 12px;border-radius:8px;color:var(--text);cursor:pointer}

/* layout */
.app{display:flex;height:calc(100% - 72px);}

/* left side panel (history) */
.side{
  width:var(--side-w);
  background:linear-gradient(180deg,#08090a,#0b0b0b);
  border-right:1px solid var(--outline);
  padding:12px;
  overflow:auto;
  transition:transform .28s ease;
  position:relative;
  z-index:10;
}
.side .menu-btn{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;cursor:pointer;border:1px solid transparent}
.side .menu-btn:hover{background:rgba(255,255,255,0.02)}
.side h3{margin:12px 0 6px;color:var(--muted);font-weight:600}

/* half-panel overlay when hamburger pressed */
.halfpanel {
  position:fixed;
  left:0;
  top:72px;
  bottom:0;
  width:50%;
  max-width:720px;
  background:linear-gradient(180deg,#060708,#0b0b0b);
  border-right:1px solid var(--outline);
  padding:18px;
  transform:translateX(-110%);
  transition:transform .28s cubic-bezier(.2,.9,.2,1);
  z-index:80;
  box-shadow: 6px 0 40px rgba(0,0,0,0.6);
  overflow:auto;
}
.halfpanel.open{transform:translateX(0%)}
.halfpanel .closeBtn{position:absolute;right:12px;top:12px;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}

/* main chat */
.main{flex:1;display:flex;flex-direction:column;position:relative}
.center-screen{flex:1;display:flex;align-items:center;justify-content:center;text-align:center;color:var(--muted)}
.chat-wrap{display:flex;flex-direction:column;gap:12px;padding:18px;max-width:900px;margin:0 auto;flex:1;overflow:auto}
.msg{padding:12px 14px;border-radius:12px;max-width:78%;white-space:pre-wrap;opacity:0;transform:translateY(6px);animation:fadeIn 240ms ease forwards}
@keyframes fadeIn{to{opacity:1;transform:none}}
.msg.user{background:#071326;margin-left:auto;border-top-right-radius:2px;color:#bfe}
.msg.ai{background:linear-gradient(180deg,#0f1720,#07101a);margin-right:auto;border-top-left-radius:2px}
.meta{font-size:12px;color:var(--muted);margin-top:4px;display:flex;gap:8px;align-items:center}

/* typing indicator */
.typing{display:inline-block;margin-left:6px;font-size:12px;color:var(--muted)}
.cursor{display:inline-block;width:10px;height:18px;margin-left:6px;background:var(--text);border-radius:2px;animation:blink 1s steps(2,end) infinite}
@keyframes blink{50%{opacity:0}}

/* input bar */
.compose{padding:12px;border-top:1px solid var(--outline);display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,#020203,#0b0b0b)}
.compose textarea{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:12px;color:var(--text);min-height:46px;resize:none}
.compose button{background:var(--accent);border:none;padding:10px 16px;border-radius:10px;font-weight:700;cursor:pointer;color:#000}

/* top-tip button style (floating top center) */
.top-tip{background:linear-gradient(180deg,#fff,#f7f7f7);border-radius:999px;padding:8px 14px;border:1px solid #eee;display:flex;align-items:center;gap:8px;cursor:pointer}
.top-tip .apple{background:linear-gradient(180deg,#92e08a,#3cb371);padding:6px;border-radius:8px;font-weight:800;color:#012}

/* small helpers */
.hint{color:var(--muted);font-size:13px;text-align:center;margin-top:8px}
.mode-pill{padding:6px 8px;border-radius:999px;background:#0c0c0c;border:1px solid var(--outline);font-size:13px;color:var(--muted)}
.fab{position:fixed;right:20px;bottom:20px;background:linear-gradient(180deg,#16c516,#0aa50a);color:#000;padding:12px 14px;border-radius:999px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(0,0,0,0.6)}

/* small responsive tweaks */
@media(max-width:880px){
  .side{display:none}
  .halfpanel{width:86%}
  .center-screen .bigBtn{width:100%}
}
  /* üî• Mobile header fix */
/* üî• Mobile header fix */
@media (max-width: 520px) {

  .top-center {
    position: absolute;
    right: 12px;
    top: 56px;
  }

  .top-tip {
    padding: 6px 10px;
    font-size: 13px;
    gap: 6px;
  }

  .top-tip .apple {
    padding: 4px;
    font-size: 14px;
  }

  .top-actions button {
    padding: 6px 10px;
    font-size: 13px;
  }
}
  
</style>
</head>
<body>
<header>
  <div style="display:flex;align-items:center;gap:12px">
    <button id="hamb" aria-label="menu" style="background:transparent;border:0;font-size:20px;cursor:pointer">‚â°</button>
    <div class="logo"><span class="fire">Zult</span><span class="x-black">X</span></div>
  </div>

  <div class="top-center">
    <!-- Top center tip button -->
    <div class="top-tip" id="topTipBtn" title="Tip ZultX">
      <span class="apple">üçè</span>
      <strong>Tip</strong>
    </div>
  </div>

  <div class="top-actions">
    <button id="lettersBtn">‚úâÔ∏è Letters</button>
    <div id="modePill" class="mode-pill">Mode: Friendly</div>
  </div>
</header>

<!-- half screen panel (opens on hamburger) -->
<div id="halfPanel" class="halfpanel" role="dialog" aria-hidden="true">
  <button class="closeBtn" onclick="closeHalf()">‚úï</button>
  <h2 style="margin-top:6px">ZultX ‚Äî History & Servers</h2>
  <p style="color:var(--muted);margin-top:8px">This panel covers half the screen (desktop/tablet). It shows chat history, servers, accounts and old AI sessions.</p>
  <hr style="border-color:var(--outline)"/>
  <div id="halfContent">
    <button style="margin:8px 0;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.03)">Account</button>
    <div style="margin-top:12px;color:var(--muted)">(This is a demo panel ‚Äî wire up your real history & servers later)</div>
  </div>
</div>

<div class="app">
  <aside class="side" id="sidePanel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="display:flex;gap:8px;align-items:center"><strong>ZultX</strong><small style="color:var(--muted)"> v1.1</small></div>
      <div style="font-size:12px;color:var(--muted)">Hardik</div>
    </div>

    <h3>Your Chats</h3>
    <div id="historyList">
      <div class="menu-btn" onclick="newChat()">+ New chat</div>
    </div>

    <h3>Letters</h3>
    <div id="lettersList" style="display:flex;flex-direction:column;gap:6px"></div>
    <div style="height:20px"></div>
    <div class="hint">Tap messages to open. Use top Tip to support.</div>
  </aside>

  <main class="main">
    <div id="centerScreen" class="center-screen">
      <div style="max-width:720px">
        <div style="font-size:28px;font-weight:800;margin-bottom:16px;color:#fff">What can I help with?</div>
        <div style="display:flex;gap:8px;justify-content:center">
          <button class="bigBtn" onclick="focusInput()" style="padding:12px 18px;border-radius:999px;border:1px solid var(--outline);background:transparent;color:var(--text);cursor:pointer">Ask About Life With ZultX..</button>
        </div>
      </div>
    </div>

    <div id="chatArea" class="chat-wrap" style="display:none"></div>

    <div class="compose">
      <textarea id="input" placeholder="Ask ZultX Positively." rows="1"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>

<!-- letters modal -->
<div id="lettersModal" style="display:none;position:fixed;left:8%;top:12%;right:8%;bottom:12%;background:#061212;border-radius:12px;padding:18px;z-index:60;overflow:auto;border:1px solid #142">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Letters</h2>
    <button onclick="closeLetters()">Close</button>
  </div>
  <div id="modalLettersContent" style="white-space:pre-wrap;color:var(--text);margin-top:12px"></div>
</div>

<!-- tip modal -->
<div id="tipModal" style="display:none;position:fixed;left:18%;top:18%;right:18%;background:#061212;border-radius:12px;padding:18px;z-index:70;border:1px solid #142">
  <h3>Tip ZultX</h3>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button onclick="createTip(10)">‚Çπ10</button>
    <button onclick="createTip(40)">‚Çπ40</button>
    <button onclick="createTip(100)">‚Çπ100</button>
    <button onclick="createTip(500)">‚Çπ500</button>
    <button onclick="createTip(1100)">‚Çπ1100</button>
  </div>
  <div style="margin-top:12px"><button onclick="closeTip()">Cancel</button></div>
</div>

<!-- UPI QR modal (desktop fallback) -->
<div id="qrModal" style="display:none;position:fixed;left:18%;top:12%;right:18%;background:#061212;border-radius:12px;padding:18px;z-index:71;border:1px solid #142;text-align:center">
  <h3>Scan to pay (UPI)</h3>
  <div id="qrImgWrap" style="margin-top:12px"></div>
  <div style="margin-top:12px">
    <button id="copyUpiBtn">Copy UPI</button>
    <button onclick="closeQr()">Close</button>
  </div>
</div>

<script>
/* ---------- helpers ---------- */
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const centerScreen = document.getElementById("centerScreen");
const sidePanel = document.getElementById("sidePanel");
const halfPanel = document.getElementById("halfPanel");
let streaming = false;

function focusInput(){
  centerScreen.style.display = "none";
  chatArea.style.display = "flex";
  input.focus();
}

function newChat(){
  chatArea.innerHTML = "";
  centerScreen.style.display = "none";
  chatArea.style.display = "flex";
  addSystemMsg("New chat started.");
}

/* message elements */
function addUserMsg(text){
  const d = document.createElement("div");
  d.className = "msg user";
  d.textContent = text;
  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
  return d;
}
function addAiMsg(text){
  const d = document.createElement("div");
  d.className = "msg ai";
  d.textContent = text || "";
  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
  return d;
}
function addSystemMsg(text){
  const d = document.createElement("div");
  d.style.textAlign = "center";
  d.style.color = "var(--muted)";
  d.style.fontSize = "13px";
  d.textContent = text;
  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
  return d;
}

/* typing indicator */
function showTyping(flag){
  let t = document.getElementById("typingIndicator");
  if(flag){
    if(!t){
      t = document.createElement("div");
      t.id = "typingIndicator";
      t.className = "meta";
      t.innerHTML = 'ZultX will answer better..<span class="cursor"></span>';
      chatArea.appendChild(t);
      chatArea.scrollTop = chatArea.scrollHeight;
    }
  } else {
    const el = document.getElementById("typingIndicator");
    if(el) el.remove();
  }
}

/* feedback row */
function addFeedbackRow(aiDiv, q){
  const row = document.createElement("div");
  row.className = "meta";
  row.innerHTML = `
    <button onclick="vote('up',this)">‚úÖ</button>
    <button onclick="vote('down',this)">‚ùé</button>
    <button onclick="generateShare(this)">Share</button>
  `;
  aiDiv.after(row);
}

/* ---------- streaming-safe sendMessage ---------- */
async function sendMessage() {
  const text = input.value.trim();
  if (!text || streaming) return;

  focusInput();
  addUserMsg(text);
  input.value = "";
  sendBtn.disabled = true;
  streaming = true;

  showTyping(true);
  const aiDiv = addAiMsg("");

  try {
    const res = await fetch(`/ask?q=${encodeURIComponent(text)}&stream=true`, {
      headers: { "Accept": "text/event-stream" }
    });

    if (!res.ok || !res.body) {
      aiDiv.textContent = "‚ö†Ô∏è Server error.";
      return;
    }

    const reader = res.body.getReader();
    const decoder = new TextDecoder("utf-8");
    let buffer = "";

    const append = (t) => {
      if (!t) return;
      aiDiv.textContent += t;
      chatArea.scrollTop = chatArea.scrollHeight;
    };

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });

      // process complete SSE lines
      const lines = buffer.split(/\r?\n/);
      buffer = lines.pop(); // keep unfinished line

      for (const line of lines) {
        if (!line.startsWith("data:")) continue;

        const payload = line.slice(5).trim();
        if (!payload || payload === "[DONE]") continue;

        let obj;
        try {
          obj = JSON.parse(payload);
        } catch {
          continue; // üö´ NEVER append raw junk
        }

        // ‚úÖ OpenAI / Mistral
        if (obj.choices?.[0]?.delta?.content) {
          append(obj.choices[0].delta.content);
          continue;
        }

        // ‚úÖ Gemini
        if (obj.candidates?.[0]?.content?.parts) {
          for (const p of obj.candidates[0].content.parts) {
            if (p.text) append(p.text);
          }
        }
      }
    }

    addFeedbackRow(aiDiv, text);

  } catch (err) {
    console.error(err);
    aiDiv.textContent = "‚ö†Ô∏è Connection lost.";
  } finally {
    showTyping(false);
    sendBtn.disabled = false;
    streaming = false;
  }
      
/* safe add used in fallback parsing */
function addToAiSafe(t){
  if(!t) return;
  const last = document.querySelector(".msg.ai:last-of-type");
  if(last) last.textContent += t;
  chatArea.scrollTop = chatArea.scrollHeight;
}

/* ---------- small utilities ---------- */
sendBtn.onclick = sendMessage;
input.addEventListener("keydown", e=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    sendMessage();
  }
});

async function vote(kind,btn){
  const payload = {type: kind, time: Date.now()};
  await fetch("/feedback", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(payload)});
  btn.textContent = kind === 'up' ? 'Thanks üëç' : 'I am sorry üòî';
}

/* share card generator */
function generateShare(btn){
  const msg = (btn.parentNode.previousSibling && btn.parentNode.previousSibling.textContent) || "";
  const canvas = document.createElement("canvas");
  canvas.width = 1200; canvas.height = 630;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#041014"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = "#fff"; ctx.font = "bold 48px Inter, Arial"; ctx.fillText("ZultX", 40, 90);
  ctx.fillStyle = "#cfe"; ctx.font = "28px Inter, Arial";
  const lines = wrapText(ctx, msg, 1120);
  let y = 160;
  for(const line of lines){
    ctx.fillText(line, 40, y);
    y += 42;
    if(y > 560) break;
  }
  const data = canvas.toDataURL("image/png");
  const link = document.createElement("a"); link.href = data; link.download = "zultx-share.png"; link.click();
}
function wrapText(ctx, text, maxWidth){
  const words = text.split(/\s+/);
  const lines = []; let current = "";
  for(const w of words){
    const test = current ? current + " " + w : w;
    const m = ctx.measureText(test).width;
    if(m > maxWidth){ lines.push(current); current = w; } else { current = test; }
  }
  if(current) lines.push(current);
  return lines;
}

/* letters */
async function loadLetters(){
  try{
    const res = await fetch("/letters");
    const data = await res.json();
    const list = document.getElementById("lettersList");
    list.innerHTML = "";
    (data.letters||[]).forEach(name=>{
      const el = document.createElement("div");
      el.className = "menu-btn";
      el.textContent = name;
      el.onclick = ()=>openLetter(name);
      list.appendChild(el);
    });
  }catch(e){}
}
async function openLetter(name){
  const res = await fetch(`/letters/${encodeURIComponent(name)}`);
  if(!res.ok) return alert("Unable to open")
  const text = await res.text();
  document.getElementById("modalLettersContent").textContent = text;
  document.getElementById("lettersModal").style.display = "block";
}
function closeLetters(){ document.getElementById("lettersModal").style.display="none" }

/* tip handling (uses your /tip endpoint) */
document.getElementById("topTipBtn").onclick = ()=>{ document.getElementById("tipModal").style.display = "block"; }
function closeTip(){ document.getElementById("tipModal").style.display = "none"; }

async function createTip(amount){
  const res = await fetch("/tip", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({amount})});
  const data = await res.json();
  if(!data.ok){
    alert("Tip creation failed: " + (data.note || data.error || "unknown"));
    closeTip(); return;
  }
  const upi_link = data.upi_link;
  const qr = data.qr;
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
  if(isMobile){
    // open UPI intent
    window.location.href = upi_link;
    closeTip();
    setTimeout(()=> {
      const ok = confirm("Did your UPI app open? Press OK if you completed payment (you can paste txn id).");
      if(ok){
        const payment_id = prompt("Optional: paste payment id / txn id","");
        fetch("/tip/confirm", {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({order_id: data.order.id, payment_id, amount})});
      }
    }, 1200);
    return;
  }
  openQr(qr, upi_link);
  closeTip();
}
function openQr(qrUrl, upiLink){
  const wrap = document.getElementById("qrImgWrap");
  wrap.innerHTML = `<img src="${qrUrl}" alt="UPI QR" style="width:280px;height:280px;border-radius:8px"/>`;
  const copyBtn = document.getElementById("copyUpiBtn");
  copyBtn.onclick = async ()=>{
    try{ await navigator.clipboard.writeText(upiLink); copyBtn.textContent = "Copied ‚úì"; }catch(e){ alert("Copy failed ‚Äî UPI link: " + upiLink); }
  };
  document.getElementById("qrModal").style.display = "block";
}
function closeQr(){ document.getElementById("qrModal").style.display = "none"; }

/* halfpanel toggles */
document.getElementById("hamb").onclick = ()=>{
  if(halfPanel.classList.contains("open")) closeHalf();
  else openHalf();
};
function openHalf(){ halfPanel.classList.add("open"); halfPanel.setAttribute("aria-hidden","false"); }
function closeHalf(){ halfPanel.classList.remove("open"); halfPanel.setAttribute("aria-hidden","true"); }

/* init */
loadLetters();
</script>
</body>
</html>

