<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ZultX ‚Äî Adaptive Reasoning AI</title>
<meta name="description" content="ZultX is Adaptive Reasoning AI system focused on very complex reasoning, friendly, and intelligent conversation." />
<meta name="robots" content="index, follow" />
<meta name="google-site-verification" content="ZPjCIwA1WKlXdH9n68BLts7CbCRwKlmwgymRsyWMawU" />
<link rel="canonical" href="https://zultx.github.io/ZultX-v2/" />
<link rel="icon" href="favicon.ico" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
  
<style>
:root{
  --bg:#0b0b0f;
  --muted:#9aa0a6;
  --text:#e8eaed;
  --accent:#f3d36b; /* golden-ish */
  --accent-strong:#ffd54a;
  --accent-dark:#b8860b;
  --outline:#1a1a1a;
  --side-w:320px;
  --header-h:72px;
  --card-bg: linear-gradient(180deg,#0e141c,#070c12);
  --glass: rgba(255,255,255,0.03);
}

/* Light theme overrides */
@media (prefers-color-scheme: light){
  :root{
    --bg:#ffffff;
    --muted:#6b7280;
    --text:#0b1220;
    --accent:#b58100;
    --accent-strong:#c89b14;
    --outline:#e6e6e6;
    --card-bg: linear-gradient(180deg,#ffffff,#fafafa);
    --glass: rgba(0,0,0,0.04);
  }
}

/* Manual theme class (overrides media) */
html.light {
  --bg:#ffffff; --muted:#6b7280; --text:#0b1220; --outline:#e6e6e6; --card-bg: linear-gradient(180deg,#ffffff,#fafafa);
}
html.dark {
  --bg:#0b0b0f; --muted:#9aa0a6; --text:#e8eaed; --outline:#141416; --card-bg: linear-gradient(180deg,#0e141c,#070c12);
}

/* Reset + base */
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:var(--text);background:var(--bg);-webkit-font-smoothing:antialiased}
a{color:inherit}

/* Header */
header{
  position:fixed;
  top:0;
  left:0;
  right:0;
  height:var(--header-h);
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 14px;
  background: rgba(255,255,255,0.78);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  color:var(--text);
  box-shadow: 0 6px 24px rgba(0,0,0,0.06);
  border-bottom:1px solid rgba(255,255,255,0.06);
  z-index:9999;
}
  
.app{
  display:flex;
  min-height:100vh;
  padding-top:var(--header-h);
  position:relative;
}

.logo{font-weight:900;display:flex;align-items:center;font-size:20px}
.logo .fire{background:linear-gradient(90deg,#ff3b3b,#ff8a00);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:900}
.logo .x-black{margin-left:6px;background:var(--outline);color:var(--text);padding:4px 8px;border-radius:8px;font-size:14px;font-weight:800}

/* header right actions */
.header-actions{display:flex;gap:10px;align-items:center}
.top-tip{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--glass);cursor:pointer}
.version-badge{font-size:13px;color:var(--muted)}
html.dark header{
  background: rgba(15,23,32,0.78);
}

/* Temp chat icon (3/4 circle) */
.temp-chat-icon{
  width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;
  border:2px solid rgba(255,255,255,0.06);background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  position:relative;font-weight:700;font-size:15px;
}
.temp-chat-icon svg{width:20px;height:20px;display:block;}

/* App layout */
.app{display:flex;min-height:calc(100vh - var(--header-h));position:relative}
.side{width:var(--side-w);background:linear-gradient(180deg,#08090a,#0b0b0b);border-right:1px solid rgba(255,255,255,0.03);padding:14px;overflow:auto}
.menu-btn{display:flex;align-items:center;gap:8px;padding:10px;border-radius:10px;cursor:pointer;background:var(--glass)}
.main{flex:1;display:flex;flex-direction:column;position:relative}

/* center initial screen with suggestion cards */
.center-screen{flex:1;display:flex;align-items:center;justify-content:center;color:var(--muted);padding:40px}
.center-inner{max-width:880px;text-align:center}
.center-title{font-size:30px;font-weight:900;margin-bottom:18px;color:var(--text)}
.suggest-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-top:8px}
.suggest-card{padding:16px;border-radius:14px;cursor:pointer;background:var(--card-bg);border:1px solid rgba(255,215,0,0.06);color:var(--text);font-weight:700;transition:all .18s ease;box-shadow:0 6px 22px rgba(0,0,0,0.25)}
.suggest-card:hover{transform:translateY(-6px);box-shadow:0 20px 40px rgba(0,0,0,0.45);outline:3px solid rgba(255,215,0,0.06)}
.start-btn{margin-top:20px;padding:12px 22px;border-radius:999px;border:1px solid var(--outline);background:transparent;color:var(--text);cursor:pointer}

/* chat area */
.chat-wrap{display:flex;flex-direction:column;gap:12px;padding:18px;max-width:920px;margin:0 auto;flex:1;overflow:auto}
.msg{
  padding:12px 16px;
  border-radius:14px;
  max-width:78%;
  line-height:1.45;
}
.msg.user{
  white-space: pre-wrap;
}

.msg.user{background:linear-gradient(180deg,#071326,#04101a);margin-left:auto;border-top-right-radius:6px;color:#cfe7ff;border-right:4px solid var(--accent-strong)}
.msg.ai{background:linear-gradient(180deg,#0f1720,#07101a);margin-right:auto;border-top-left-radius:6px;color:#eef6ff;border-left:4px solid var(--accent-strong)}

/* gold bubble highlight for light theme */
html.light .msg.user{background:linear-gradient(180deg,#fff,#fbfbfb);color:var(--text);border-right:4px solid var(--accent)}
html.light .msg.ai{background:linear-gradient(180deg,#f7f7f7,#efefef);color:var(--text);border-left:4px solid var(--accent)}

/* compose area */
.compose{padding:12px;border-top:1px solid rgba(255,255,255,0.03);display:flex;gap:8px;align-items:center;background:linear-gradient(180deg,transparent,var(--bg))}
.compose textarea{flex:1;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:12px;color:var(--text);min-height:46px;resize:none}
.compose button{background:var(--accent-strong);border:none;padding:10px 16px;border-radius:10px;font-weight:800;cursor:pointer;color:#0a0a0a}

/* history */
.history-item{padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);cursor:pointer;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center}
.history-item .meta{font-size:12px;color:var(--muted)}

/* small text */
.hint{color:var(--muted);font-size:13px;text-align:center;margin-top:8px}
.small-muted{font-size:12px;color:var(--muted)}

/* modals */
.modal{display:none;position:fixed;left:8%;top:10%;right:8%;bottom:10%;background:var(--card-bg);border-radius:12px;padding:18px;z-index:10030;overflow:auto;border:1px solid rgba(255,255,255,0.04)}
.modal.sm{width:420px;left:calc(50% - 210px);right:auto}
#shareBtn:hover{
  box-shadow:0 0 16px rgba(255,215,0,0.25);
}
/* Glow effect for all top header buttons */
.header-actions .top-tip:hover,
.header-actions #lettersBtn:hover,
.header-actions #themeToggle:hover,
.temp-chat-icon:hover{
  box-shadow: 0 0 16px rgba(255,215,0,0.28);
  transform: translateY(-1px);
}
.header-actions .top-tip,
.header-actions #lettersBtn,
.temp-chat-icon{
  transition: box-shadow .18s ease, transform .18s ease;
}
/* Markdown formatting */
.msg.ai h1, .msg.ai h2, .msg.ai h3 {
  margin: 12px 0 8px;
  font-weight: 900;
}

.msg.ai table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
  display: block;
  overflow-x: auto;
}

.msg.ai th, .msg.ai td {
  border: 1px solid rgba(255,255,255,0.12);
  padding: 8px 10px;
  text-align: left;
  white-space: nowrap;
}

.msg.ai th {
  background: rgba(255,215,0,0.08);
  font-weight: 800;
}

/* Code blocks */
/* Default (LIGHT THEME) */
.msg.ai pre{
  background: #f8f9fb;
  color: #1e1e1e;
  border-radius: 12px;
  padding: 14px;
  overflow-x: auto;
  font-size: 0.95em;
  border: 1px solid rgba(0,0,0,0.06);
}

/* DARK THEME */
html.dark .msg.ai pre{
  background: #0f1720;
  color: #e5e7eb;
  border: 1px solid rgba(255,255,255,0.08);
}
.msg.ai pre {
  position: relative;
}

.msg.ai pre::before {
  content: attr(data-lang);
  position: absolute;
  top: 6px;
  left: 10px;
  font-size: 11px;
  font-weight: 800;
  color: #22c55e;
}
  
/* Inline code ‚Äì green and readable */
.msg.ai p code {
  background: rgba(34,197,94,0.15);
  color: #15803d;
  padding: 2px 6px;
  border-radius: 6px;
  font-size: 0.95em;
  font-weight: 500;
}

html.dark .msg.ai p code {
  background: rgba(34,197,94,0.25);
  color: #4ade80;
}

/* Let highlight.js control BLOCK code colors */
.msg.ai pre code {
  color: inherit;
}


.msg.ai table {
  background: linear-gradient(180deg, rgba(255,255,255,0.03), transparent);
  border-radius: 12px;
  overflow: hidden;
}

.msg.ai tr:nth-child(even) td {
  background: rgba(255,255,255,0.02);
}

.msg.ai tr:hover td {
  background: rgba(255,215,0,0.06);
}
.msg.ai blockquote{
  border-left:4px solid var(--accent);
  padding:10px 14px;
  margin:12px 0;
  background: rgba(255,215,0,0.06);
  border-radius:10px;
  font-style:italic;
}
.msg.ai ul, .msg.ai ol{
  padding-left:22px;
  margin:10px 0;
}

.msg.ai li{
  margin:6px 0;
}

  
/* Copy button */
.copy-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: rgba(255,215,0,0.15);
  border: none;
  color: #ffd54a;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 8px;
  cursor: pointer;
  }

/* Premium full-screen modal (golden) */
.premium-modal {
  display:none;
  position:fixed;
  inset:0;
  background: linear-gradient(180deg, rgba(12,8,6,0.94), rgba(16,12,10,0.96));
  z-index:12000;
  align-items:center;
  justify-content:center;
  padding:28px;
  backdrop-filter: blur(8px);
}
.premium-card {
  width:100%;
  max-width:920px;
  border-radius:18px;
  padding:28px;
  background: linear-gradient(180deg, rgba(255,250,240,0.03), rgba(255,244,200,0.02));
  border: 1px solid rgba(255,215,0,0.18);
  box-shadow: 0 30px 80px rgba(0,0,0,0.6), 0 2px 12px rgba(255,215,0,0.04) inset;
  color: var(--text);
}
.premium-header { display:flex;justify-content:space-between;align-items:center;gap:12px; }
.premium-title { font-size:28px;font-weight:900;color:var(--accent-strong); }
.premium-sub { color:var(--muted); font-size:14px; }

/* form */
.premium-form { margin-top:18px; display:flex;flex-direction:column; gap:12px; }
.premium-form input {
  padding:12px;
  border-radius:10px;
  border:1px solid rgba(255,215,0,0.3);
  background: #ffffff;
  color: #111;
  font-weight:600;
  }
.premium-actions { display:flex; gap:10px; margin-top:10px; align-items:center; }

/* eye toggle button */
.pw-eye { background:transparent;border:none;color:var(--accent-strong); cursor:pointer; padding:8px;border-radius:8px; }

/* left-panel account line styling */
.side .account-row { padding:8px 10px; margin-bottom:12px; display:flex;justify-content:space-between;align-items:center; border-radius:8px; background:rgba(255,255,255,0.01); }
.account-btn { padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:800; }
.account-btn.login { background: #0f7f3e; color: #fff; border:1px solid rgba(255,255,255,0.04); }
.account-btn.logout { background: #7a1f1f; color:#fff; border:1px solid rgba(255,255,255,0.04); }
.account-welcome { color: var(--muted); font-size:13px; }
.premium-actions button,
.premium-form .menu-btn {
  background: #ffffff;
  color: #111;
  font-weight:800;
  }

/* Premium Close Button Override */
#premiumClose {
  background: linear-gradient(90deg,#ffffff,#fff6cc);
  color:#111;
  font-weight:800;
}


#premiumClose:hover {
  background: #f3d36b;
  color: #000;
  }


/* temp chats list */
.temp-list{display:flex;flex-direction:column;gap:8px;margin-top:12px}
.temp-entry{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between;align-items:center}
/* responsive */
@media (max-width:880px){ .side{display:none} .center-inner{padding:8px} .suggest-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))} }
</style>
  
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  marked.setOptions({
    gfm: true,        // GitHub-style markdown (tables, task lists)
    breaks: true,    // Line breaks without double enter
    smartLists: true,
    smartypants: true
  });
</script>
  
<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">

</head>
<body class="dark">
<header>
  <div style="display:flex;gap:12px;align-items:center">
    <div class="logo">
      <span class="fire">Zult</span><span class="x-black">X</span>
    </div>
    <div class="small-muted" style="font-weight:700">ZultX ‚Äî v1.4</div>
  </div>

  <div class="header-actions">
    <div id="themeToggle" class="top-tip" title="Toggle light / dark"><span id="themeIcon">üåó</span></div>
    <div id="topTipBtn" class="top-tip"><span>üçè</span><strong style="margin-left:6px">Tip</strong></div>
    <div id="lettersBtn" style="padding:8px 10px;border-radius:10px;background:var(--glass);cursor:pointer">‚úâÔ∏è Letters</div>
    <div id="shareBtn" class="top-tip" title="Share ZultX"><span>üîó</span><strong style="margin-left:6px">Share</strong></div>


    <!-- temp chat 3/4 circle icon -->
    <div id="tempChatBtn" class="temp-chat-icon" title="Temporary chats">
      <!-- simple 3/4 circle SVG -->
      <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M12 2a10 10 0 1 0 10 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="12" cy="12" r="9" fill="none" stroke="rgba(255,215,0,0.06)" stroke-width="2"/>
      </svg>
    </div>

    <div class="version-badge">v1.4</div>
  </div>
</header>

<div class="app">
  <aside class="side">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div><strong>ZultX</strong><div class="small-muted">Your AI Assistant</div></div>
      <div class="small-muted">USER</div>
    </div>

    <h3 style="margin-top:6px">Your Chats</h3>
    <div id="historyList" aria-live="polite"></div>

    <div style="height:12px"></div>
    <div class="menu-btn" id="newChatBtn">+ New chat</div>
    <div style="height:14px"></div>
    <div class="hint">Local history (stored in your browser). Hold / right-click an item to delete.</div>
  </aside>

  <main class="main">
    <!-- center suggestion / hero -->
    <div id="centerScreen" class="center-screen">
      <div class="center-inner">
        <div class="center-title">What can ZultX help with?</div>

        <div class="suggest-grid" id="suggestGrid">
          <div class="suggest-card" data-q="Make a list of beautiful flowers with their meanings">üå∏ List of flowers & meanings</div>
          <div class="suggest-card" data-q="Create a loving world filled with happiness and kindness">üåç Create a loving world</div>
          <div class="suggest-card" data-q="Explain black holes in simple words">üï≥Ô∏è Black holes explained</div>
          <div class="suggest-card" data-q="Give me short study motivation for board exams">‚ö° Motivation for exams</div>
        </div>

        <button id="startBtn" class="start-btn">Ask Something New</button>
      </div>
    </div>

    <!-- chat area (hidden initially) -->
    <div id="chatArea" class="chat-wrap" style="display:none" aria-live="polite"></div>

    <!-- compose -->
    <div class="compose">
      <textarea id="input" placeholder="Ask ZultX something positive..." rows="1" aria-label="Your message"></textarea>
      <button id="sendBtn">Send</button>
    </div>
  </main>
</div>

<!-- Letters modal -->
<div id="lettersModal" class="modal sm" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Letters</h2>
    <button id="closeLettersBtn">Close</button>
  </div>
  <pre id="modalLettersContent" style="white-space:pre-wrap;color:var(--text);margin-top:12px"></pre>
</div>

<!-- Tip & QR modal -->
<div id="tipModal" class="modal sm" aria-hidden="true">
  <h3>Tip ZultX</h3>
  <div style="display:flex;gap:8px;margin-top:12px">
    <button onclick="createTip(10)">‚Çπ10</button>
    <button onclick="createTip(40)">‚Çπ40</button>
    <button onclick="createTip(100)">‚Çπ100</button>
    <button onclick="createTip(500)">‚Çπ500</button>
  </div>
  <div style="margin-top:12px"><button id="closeTipBtn">Cancel</button></div>
  <button id="copyUpiBtn" style="margin-top:8px">Copy UPI ‚Äî 9358588509@fam</button>
</div>

<!-- Temp chats modal -->
<div id="tempModal" class="modal" aria-hidden="true">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h2>Temporary Chats</h2>
    <button id="closeTempBtn">Close</button>
  </div>
  <div style="margin-top:12px" class="small-muted">Temporary chats are not saved to history. Long-press or right-click to delete.</div>
  <div id="tempList" class="temp-list"></div>
</div>

<script>
/* -------------- CONFIG / STATE -------------- */
const API_BASE = "https://zultx.up.railway.app"; // adjust if needed
const chatArea = document.getElementById("chatArea");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const startBtn = document.getElementById("startBtn");
const centerScreen = document.getElementById("centerScreen");
const historyList = document.getElementById("historyList");
const newChatBtn = document.getElementById("newChatBtn");
const suggestGrid = document.getElementById("suggestGrid");

const lettersBtn = document.getElementById("lettersBtn");
const lettersModal = document.getElementById("lettersModal");
const modalLettersContent = document.getElementById("modalLettersContent");
const closeLettersBtn = document.getElementById("closeLettersBtn");
const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
const topTipBtn = document.getElementById("topTipBtn");
const tipModal = document.getElementById("tipModal");
const closeTipBtn = document.getElementById("closeTipBtn");
const copyUpiBtn = document.getElementById("copyUpiBtn");

const tempChatBtn = document.getElementById("tempChatBtn");
const tempModal = document.getElementById("tempModal");
const tempList = document.getElementById("tempList");
const closeTempBtn = document.getElementById("closeTempBtn");

const themeToggle = document.getElementById("themeToggle");
const themeIcon = document.getElementById("themeIcon");

let currentConversationId = null;
let tempMode = false; // if true, don't save to local history
let longPressTimer = null;

/* -------------- HISTORY STORAGE -------------- */
function makeConvoId(prefix='convo'){ return `${prefix}_${Date.now()}`; }

function getAllHistory(){
  const key = 'zultx_history';
  try{
    return JSON.parse(localStorage.getItem(key) || '{}');
  }catch(e){
    return {};
  }
}

function setAllHistory(obj){
  localStorage.setItem('zultx_history', JSON.stringify(obj));
}

function refreshHistoryList(){
  const all = getAllHistory();
  const keys = Object.keys(all).sort((a,b)=> all[b].created - all[a].created);
  historyList.innerHTML = '';
  for(const k of keys){
    const item = all[k];
    const el = document.createElement('div');
    el.className = 'history-item';
    const last = (item.messages && item.messages[item.messages.length-1]) || null;
    el.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px"><div style="font-weight:700">${item.id}</div><div class="meta">${last? last.text.slice(0,48) : 'New chat'}</div></div><div class="small-muted">${new Date(item.created).toLocaleString()}</div>`;
    // click opens
    el.onclick = ()=> openConversation(k);
    // right-click / hold to delete
    el.oncontextmenu = (e)=> {
      e.preventDefault();
      confirmAndDelete(k);
    };
    // touch long-press support: show delete on long hold
    let pressTimer = null;
    el.addEventListener('touchstart', (e)=>{
      pressTimer = setTimeout(()=> confirmAndDelete(k), 650);
    }, {passive:true});
    el.addEventListener('touchend', ()=> { clearTimeout(pressTimer); }, {passive:true});
    historyList.appendChild(el);
  }
}

/* save message but skip if in tempMode */
function saveMessageToHistory(convoId, role, text){
  if(tempMode) return;
  const all = getAllHistory();
  all[convoId] = all[convoId] || { id: convoId, created: Date.now(), messages: [] };
  all[convoId].messages.push({ role, text, t: Date.now() });
  setAllHistory(all);
  refreshHistoryList();
}

function fakeStream(element, fullText, speed = 15) {
  element.innerHTML = "";
  let i = 0;

  function type() {
    if (i < fullText.length) {
      element.textContent += fullText[i];
      i++;
      element.scrollIntoView({ behavior: "smooth", block: "end" });
      setTimeout(type, speed);
    } else {
      element.innerHTML = marked.parse(fullText);

      // highlight + copy buttons AFTER render
      element.querySelectorAll("pre code").forEach(block => {
        hljs.highlightElement(block);
      });

      enhanceCodeBlocks(element);
    }
  }

  type();
}

/* load conversation */
function loadConversation(convoId){
  const all = getAllHistory();
  return all[convoId] || null;
}

function localSaveInit(convoId){
  const all = getAllHistory();
  if(!all[convoId]) all[convoId] = { id: convoId, created: Date.now(), messages: [] };
  setAllHistory(all);
}

/* delete chat local + optional server call */
function confirmAndDelete(convoId){
  if(!confirm("Delete this chat forever? This removes local history (and attempts server delete if available).")) return;
  const all = getAllHistory();
  if(all[convoId]) delete all[convoId];
  setAllHistory(all);
  refreshHistoryList();
  // if server supports history deletion, attempt call (best-effort)
  (async()=>{
    try{
      await fetch(`${API_BASE}/history/delete?id=${encodeURIComponent(convoId)}`, { method: 'DELETE' , mode:'cors' });
    }catch(e){
      // ignore
    }
    // if currently viewing it, reset UI
    if(currentConversationId === convoId){
      currentConversationId = null;
      chatArea.innerHTML = '';
      centerScreen.style.display = 'flex';
      chatArea.style.display = 'none';
    }
  })();
}

/* -------------- UI helpers -------------- */
function addBubble(kind, text, stream = true){
  const d = document.createElement('div');
  d.className = 'msg ' + (kind === 'user' ? 'user' : 'ai');

  if(kind === 'ai'){
    if(stream){
      fakeStream(d, text, 5);
    } else {
      d.innerHTML = marked.parse(text);
      d.querySelectorAll("pre code").forEach(b => hljs.highlightElement(b));
      enhanceCodeBlocks(d);
    }
  } else {
    d.textContent = text;
  }

  chatArea.appendChild(d);
  chatArea.scrollTop = chatArea.scrollHeight;
}
 

function addUserMsg(text){ addBubble('user', text); saveMessageToHistory(currentConversationId, 'user', text); }
function addAiMsg(text){ addBubble('ai', text); saveMessageToHistory(currentConversationId, 'ai', text); }
function addSystemMsg(text){
  const d = document.createElement('div'); d.style.textAlign='center'; d.style.color='var(--muted)'; d.textContent = text; chatArea.appendChild(d); chatArea.scrollTop = chatArea.scrollHeight;
}
function enhanceCodeBlocks(container){
  container.querySelectorAll('pre code').forEach(block => {
  const pre = block.parentElement;
  if(pre.classList.contains('code-enhanced')) return;
  pre.classList.add('code-enhanced');

  // detect language from markdown ```lang
  const className = block.className || '';
  const match = className.match(/language-(\w+)/);
  pre.setAttribute('data-lang', match ? match[1].toUpperCase() : 'CODE');

  const btn = document.createElement('button');
  btn.textContent = 'Copy';
  btn.className = 'copy-btn';

  btn.onclick = () => {
    navigator.clipboard.writeText(block.innerText);
    btn.textContent = 'Copied ‚úÖ';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  };

  pre.style.position = 'relative';
  pre.appendChild(btn);
});
}
  
/* -------------- SEND MESSAGE (no stream) -------------- */
async function sendMessage(){
  const text = input.value.trim();
  if(!text) return;

  // ensure chat visible
  centerScreen.style.display = 'none';
  chatArea.style.display = 'flex';

  // create conversation if missing
  if(!currentConversationId){
    currentConversationId = makeConvoId();
    localSaveInit(currentConversationId);
  }

  addUserMsg(text);
  input.value = '';
  sendBtn.disabled = true;

  // insert temporary AI bubble
  const aiDiv = document.createElement('div');
  aiDiv.className = 'msg ai';
  aiDiv.textContent = 'ZultX is thinking deep..';
  chatArea.appendChild(aiDiv);
  chatArea.scrollTo({ top: chatArea.scrollHeight, behavior: "smooth" });

  try{
    // call non-stream endpoint; always returns JSON { answer: "..." }
    const res = await fetch(`${API_BASE}/ask?q=${encodeURIComponent(text)}`, {
      headers: { "Accept": "application/json" },
      method: "GET",
    });

    if(!res.ok){
      aiDiv.textContent = "‚ö†Ô∏è Server error ‚Äî Make sure connection is working.";
      saveMessageToHistory(currentConversationId, 'ai', aiDiv.textContent);
      return;
    }

    const data = await res.json();
    const ans = (data && data.answer) ? data.answer : "I cannot compute it safely. Is there anything else I can help with?";
    fakeStream(aiDiv, ans, 9); // üëà STREAM SPEED
    saveMessageToHistory(currentConversationId, 'ai', ans);
    
  } catch(err){
    console.error(err);
    aiDiv.textContent = "‚ö†Ô∏è Connection failed - Check your network.";
    saveMessageToHistory(currentConversationId, 'ai', aiDiv.textContent);
  } finally {
    sendBtn.disabled = false;
    refreshHistoryList();
  }
}

/* -------------- OPEN / NEW CONVERSATION -------------- */
startBtn.addEventListener('click', ()=> {
  tempMode = false;
  currentConversationId = makeConvoId();
  localSaveInit(currentConversationId);
  chatArea.innerHTML = '';
  centerScreen.style.display = 'none';
  chatArea.style.display = 'flex';
  addSystemMsg('New chat started.');
  refreshHistoryList();
});

newChatBtn.addEventListener('click', ()=> {
  tempMode = false;
  currentConversationId = makeConvoId();
  localSaveInit(currentConversationId);
  chatArea.innerHTML = '';
  centerScreen.style.display = 'none';
  chatArea.style.display = 'flex';
  addSystemMsg('New chat started.');
  refreshHistoryList();
});

function openConversation(convoId){
  tempMode = false;
  currentConversationId = convoId;
  const convo = loadConversation(convoId);
  chatArea.innerHTML = '';
  centerScreen.style.display = 'none';
  chatArea.style.display = 'flex';
  if(convo && convo.messages){
    for(const m of convo.messages){
      addBubble(m.role === 'user' ? 'user' : 'ai', m.text, false);
    }
  }
}

/* -------------- SUGGESTION CARDS -------------- */
document.querySelectorAll('.suggest-card').forEach(card=>{
  card.onclick = ()=>{
    const q = card.dataset.q;
    input.value = q;
    centerScreen.style.display='none';
    chatArea.style.display='flex';
    // create a temp conversation for instant suggestion (we want user to be able to save it)
    currentConversationId = makeConvoId();
    localSaveInit(currentConversationId);
    sendMessage();
  };
});

/* -------------- TEMP CHAT MODE + TEMP LIST -------------- */
tempChatBtn.onclick = ()=>{
  // open temp modal with list
  populateTempList();
  tempModal.style.display = 'block';
  document.body.style.overflow = 'hidden';
};

closeTempBtn && (closeTempBtn.onclick = ()=>{
  tempModal.style.display = 'none';
  document.body.style.overflow = '';
});

function createTempConversation(){
  tempMode = true;
  currentConversationId = makeConvoId('temp');
  // don't call localSaveInit for temp (we keep transient objects but we may store a lightweight snapshot in memory if desired)
  chatArea.innerHTML = '';
  centerScreen.style.display = 'none';
  chatArea.style.display = 'flex';
  addSystemMsg('Temporary chat started (will not be saved).');
  refreshHistoryList();
}

/* build list of temp conversations stored in localStorage as those starting with 'temp_' */
function populateTempList(){
  tempList.innerHTML = '';
  const all = getAllHistory();
  const tempKeys = Object.keys(all).filter(k => k.startsWith('temp_')).sort((a,b)=> all[b].created - all[a].created);
  // show a button to start a new temporary chat
  const newBtn = document.createElement('div');
  newBtn.className = 'menu-btn';
  newBtn.textContent = '+ New temporary chat';
  newBtn.onclick = ()=> { createTempConversation(); tempModal.style.display='none'; document.body.style.overflow=''; };
  tempList.appendChild(newBtn);

  if(tempKeys.length === 0){
    const p = document.createElement('div'); p.className='small-muted'; p.textContent='No temporary chats found (they are not saved by default).';
    tempList.appendChild(p);
    return;
  }

  for(const k of tempKeys){
    const entry = all[k];
    const el = document.createElement('div');
    el.className = 'temp-entry';
    el.innerHTML = `<div style="display:flex;flex-direction:column"><strong>${entry.id}</strong><div class="small-muted">${entry.messages && entry.messages.length ? entry.messages[entry.messages.length-1].text.slice(0,60) : 'Empty'}</div></div><div style="display:flex;gap:8px"><button data-id="${k}" class="open-temp">Open</button><button data-id="${k}" class="del-temp">Delete</button></div>`;
    tempList.appendChild(el);
  }

  // bind open + delete
  tempList.querySelectorAll('.open-temp').forEach(btn=>{
    btn.onclick = (e)=> {
      const id = btn.dataset.id;
      tempMode = true;
      currentConversationId = id;
      const convo = loadConversation(id);
      chatArea.innerHTML = '';
      centerScreen.style.display = 'none';
      chatArea.style.display = 'flex';
      if(convo && convo.messages) convo.messages.forEach(m=> addBubble(m.role === 'user' ? 'user' : 'ai', m.text));
      tempModal.style.display = 'none';
      document.body.style.overflow = '';
    };
  });
  tempList.querySelectorAll('.del-temp').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.dataset.id;
      if(!confirm("Delete this temporary chat?")) return;
      const all = getAllHistory();
      delete all[id];
      setAllHistory(all);
      populateTempList();
      refreshHistoryList();
      // try server delete
      try{ await fetch(`${API_BASE}/history/delete?id=${encodeURIComponent(id)}`, { method:'DELETE' }); }catch(e){}
    };
  });
}

/* -------------- Letters / Tips ‚Äî same as before -------------- */
lettersBtn.addEventListener('click', async ()=>{
  try{
    const res = await fetch(`${API_BASE}/letters`);
    if(!res.ok) return alert('No letters');
    const data = await res.json();
    const name = (data.letters && data.letters.length) ? data.letters[0] : null;
    if(!name) { modalLettersContent.textContent = 'No letters found'; lettersModal.style.display='block'; return; }
    const r2 = await fetch(`${API_BASE}/letters/` + encodeURIComponent(name));
    const text = await r2.text();
    modalLettersContent.textContent = text;
    lettersModal.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }catch(e){ alert('Unable to load letters'); console.error(e); }
});
closeLettersBtn.addEventListener('click', ()=> { lettersModal.style.display='none'; document.body.style.overflow=''; });

topTipBtn.addEventListener('click', ()=> { tipModal.style.display='block'; document.body.style.overflow='hidden'; });
closeTipBtn.addEventListener('click', ()=> { tipModal.style.display='none'; document.body.style.overflow=''; });

copyUpiBtn && (copyUpiBtn.onclick = async ()=> {
  try{
    await navigator.clipboard.writeText('9358588509@fam');
    alert('UPI copied: 9358588509@fam');
  }catch(e){
    alert('Copy failed. UPI: 9358588509@fam');
  }
});

/* createTip uses your existing backend /tip endpoint; this is safe best-effort */
async function createTip(amount){
  try{
    const res = await fetch(`${API_BASE}/tip`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ amount })
    });
    const data = await res.json();
    if(!data || !data.upi_link) throw new Error("No UPI");
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
    if(isMobile){
      window.location.href = data.upi_link;
    } else {
      // desktop -> show QR in new window
      window.open(data.qr, '_blank');
      alert('Use UPI link or scan QR from the new tab.');
    }
  }catch(e){
    alert("Payment couldn't auto-open. Open your UPI app ‚Üí Pay via UPI ID ‚Üí Paste: 9358588509@fam");
  }
}

/* -------------- THEME TOGGLE -------------- */
function applyInitialTheme(){
  // prefer user's manual or system. body class controls theme (html element)
  const saved = localStorage.getItem('zultx_theme');
  if(saved === 'light') document.documentElement.className = 'light';
  else if(saved === 'dark') document.documentElement.className = 'dark';
  else {
    // no saved -> respect system (media handled by CSS) but set class to match computed bg
    const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
    document.documentElement.className = prefersLight ? 'light' : 'dark';
  }
  updateThemeIcon();
}
function toggleTheme(){
  const cur = document.documentElement.className === 'light' ? 'light' : 'dark';
  const next = cur === 'light' ? 'dark' : 'light';
  document.documentElement.className = next;
  localStorage.setItem('zultx_theme', next);
  updateThemeIcon();
}
function updateThemeIcon(){
  const isLight = document.documentElement.className === 'light';
  themeIcon.textContent = isLight ? 'üåû' : 'üåô';
}
themeToggle.onclick = toggleTheme;
applyInitialTheme();

const shareBtn = document.getElementById('shareBtn');

shareBtn.onclick = async ()=>{
  const shareData = {
    title: 'ZultX AI',
    text: 'ZultX ‚Äî Fast, Positive, Experimental AI. Try it now.',
    url: 'https://zultx.github.io/ZultX-v2/'
  };

  // Mobile / supported browsers
  if(navigator.share){
    try{
      await navigator.share(shareData);
    }catch(e){
      // user cancelled, ignore
    }
  } else {
    // Desktop fallback ‚Üí copy link
    try{
      await navigator.clipboard.writeText(shareData.url);
      alert('Link copied! Share ZultX anywhere üöÄ');
    }catch(e){
      prompt('Copy & share this link:', shareData.url);
    }
  }
};

/* -------------- BINDINGS -------------- */
sendBtn.addEventListener('click', sendMessage);
input.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    if (isMobile) {
      // üì± MOBILE ‚Üí allow newline
      return;
    }

    // üíª PC ‚Üí send (keep your old behavior)
    e.preventDefault();
    sendMessage();
  }
});

/* init: ensure conversation exists */
if(!currentConversationId){
  currentConversationId = makeConvoId();
  localSaveInit(currentConversationId);
}
refreshHistoryList();

/* show centerScreen for first load */
centerScreen.style.display = 'flex';
chatArea.style.display = 'none';
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<!-- PREMIUM FULLSCREEN AUTH MODAL -->
<div id="premiumAuth" class="premium-modal" aria-hidden="true">
  <div class="premium-card" role="dialog" aria-modal="true">
    <div class="premium-header">
      <div>
        <div class="premium-title">ZultX ‚Äî Account Access</div>
        <div class="premium-sub">Sign up or login to unlock saved memories & preferences. Try free without signup.</div>
      </div>
      <div>
        <button id="premiumClose" class="menu-btn">Close</button>
      </div>
    </div>

    <div class="premium-form" id="premiumFormArea">
      <input id="p_username" placeholder="Username" />
      <input id="p_email" placeholder="Email (signup only)" style="display:none;" />
      <div style="position:relative; display:flex; gap:8px; align-items:center;">
        <input id="p_password" type="password" placeholder="Password" style="flex:1;" />
        <button id="p_eye" class="pw-eye" title="Show/Hide password">üëÅÔ∏è</button>
      </div>

      <div style="display:flex;gap:10px;align-items:center">
        <button id="p_submit" class="menu-btn">Login</button>
        <button id="p_toggle" class="menu-btn">Switch to Signup</button>
        <button id="p_guest" class="menu-btn" title="Try without login">Try without login</button>
        <div id="p_msg" class="small-muted" style="margin-left:8px"></div>
      </div>
    </div>

    <div style="margin-top:12px;color:var(--muted);font-size:13px">
      <strong>Note:</strong> Username must be unique. Password is hidden by default ‚Äî use the eye button to preview.
    </div>
  </div>
</div>

<script>
// ============================
// AUTH CORE HELPERS (REQUIRED)
// ============================

function ensureSessionId(){
  let sid = localStorage.getItem('zultx_session');
  if(!sid){
    sid = 'sess_' + Math.random().toString(36).slice(2) + '_' + Date.now();
    localStorage.setItem('zultx_session', sid);
  }
  return sid;
}

function setToken(token){
  if(token){
    localStorage.setItem('zultx_token', token);
  } else {
    localStorage.removeItem('zultx_token');
  }
}

function getToken(){
  return localStorage.getItem('zultx_token');
}

function loggedIn(){
  return !!getToken();
}
</script>

<script>
/* PREMIUM AUTH JS (replace previous auth handlers) */
const PREMIUM_AUTH = document.getElementById('premiumAuth');
const P_CLOSE = document.getElementById('premiumClose');
const P_USERNAME = document.getElementById('p_username');
const P_EMAIL = document.getElementById('p_email');
const P_PASSWORD = document.getElementById('p_password');
const P_SUBMIT = document.getElementById('p_submit');
const P_TOGGLE = document.getElementById('p_toggle');
const P_GUEST = document.getElementById('p_guest');
const P_EYE = document.getElementById('p_eye');
const P_MSG = document.getElementById('p_msg');

let premiumMode = 'login'; // login | signup

function openPremium(mode='login'){
  premiumMode = mode;
  P_EMAIL.style.display = mode === 'signup' ? 'block' : 'none';
  P_SUBMIT.textContent = mode === 'signup' ? 'Create account' : 'Login';
  P_TOGGLE.textContent = mode === 'signup' ? 'Switch to Login' : 'Switch to Signup';
  P_MSG.textContent = '';
  P_USERNAME.value = '';
  P_PASSWORD.value = '';
  PREMIUM_AUTH.style.display = 'flex';
  document.body.style.overflow = 'hidden';
}
function closePremium(){ PREMIUM_AUTH.style.display = 'none'; document.body.style.overflow = ''; }

P_CLOSE.onclick = closePremium;
P_TOGGLE.onclick = () => openPremium(premiumMode === 'signup' ? 'login' : 'signup');
P_GUEST.onclick = () => { ensureSessionId(); closePremium(); alert('Guest session active.'); };

P_EYE.onclick = () => {
  if(P_PASSWORD.type === 'password'){ P_PASSWORD.type = 'text'; P_EYE.textContent = 'üôà'; }
  else { P_PASSWORD.type = 'password'; P_EYE.textContent = 'üëÅÔ∏è'; }
}

// check username availability (signup)
async function checkUsernameAvailable(un){
  try{
    const r = await fetch(`${API_BASE}/check_username?username=${encodeURIComponent(un)}`);
    if(!r.ok) return false;
    const d = await r.json();
    return !!d.available;
  }catch(e){ return false; }
}

P_SUBMIT.onclick = async () => {
  const u = P_USERNAME.value.trim();
  const p = P_PASSWORD.value;
  const e = P_EMAIL.value.trim();

  if(!u || !p){ P_MSG.textContent = 'username & password required'; return; }

  if(premiumMode === 'signup'){
    // unique username check
    P_MSG.textContent = 'Checking availability...';
    const ok = await checkUsernameAvailable(u);
    if(!ok){ P_MSG.textContent = 'Username not available'; return; }
  }

  P_MSG.textContent = 'Contacting server...';
  const url = premiumMode === 'signup' ? `${API_BASE}/signup` : `${API_BASE}/login`;
  const body = premiumMode === 'signup' ? { username: u, password: p, email: e } : { username: u, password: p };

  try{
    const res = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(body)
    });
    const data = await res.json();
    if(!res.ok || !data.ok){
      P_MSG.textContent = data.error || 'Auth failed';
      return;
    }
    // store token & update UI
    setToken(data.token);
    P_MSG.textContent = '';
    closePremium();
    refreshAccountUI();
    alert('Welcome, ' + (data.user.username || 'you') + ' ‚Äî logged in!');
  }catch(err){
    console.error(err);
    P_MSG.textContent = 'Network error';
  }
};

/* Left side account row creation & behavior */
(function addLeftAccountRow(){
  const side = document.querySelector('.side');
  if(!side) return;
  const row = document.createElement('div');
  row.className = 'account-row';
  row.innerHTML = `<div><div style="font-weight:800">Account</div><div class="account-welcome" id="accWelcome">Not signed in</div></div><div><button id="accBtn" class="account-btn login">Login</button></div>`;
  side.insertBefore(row, side.firstChild);
  // bind click
  document.getElementById('accBtn').onclick = () => {
    if(loggedIn()){
      if(confirm("Log out?")) {
        setToken(null);
        refreshAccountUI();
        alert('Logged out');
      }
    } else {
      openPremium('login');
    }
  };
})();

function refreshAccountUI(){
  const btn = document.getElementById('accBtn');
  const welcome = document.getElementById('accWelcome');
  if(!btn || !welcome) return;
  if(loggedIn()){
    btn.classList.remove('login'); btn.classList.add('logout');
    btn.textContent = 'Logout';
    // fetch some user info optionally if backend supports /me (not implemented here)
    welcome.textContent = 'Welcome ‚Äî signed in';
  } else {
    btn.classList.add('login'); btn.classList.remove('logout');
    btn.textContent = 'Login';
    welcome.textContent = 'Not signed in';
  }
}
refreshAccountUI();
</script>
</body>
</html>
